<!DOCTYPE html>
<html lang="en" ng-app="editor">
<head>
    <meta charset="utf-8">
    <title>Bootstrap, from Twitter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.min.css">
  	<link rel="stylesheet" type="text/css" href="../assets/css/font-awesome.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/global.css" />
    <link type="text/css" rel="stylesheet" href="../assets/css/color-button.css" />

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../assets/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="stylesheet" href="../assets/js/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="../assets/js/codemirror/theme/monokai.css">
  	<link rel="stylesheet" href="../assets/js/codemirror/theme/ambiance.css">
  	
    <script src="../assets/js/codemirror/lib/codemirror.js"></script>
    <script src="../assets/js/codemirror/mode/javascript/javascript.js"></script>
    <script src="../assets/js/codemirror/mode/css/css.js"></script>
    <script src="../assets/js/codemirror/mode/xml/xml.js"></script>
    <script src="../assets/js/codemirror/mode/htmlmixed/htmlmixed.js"></script>
    <script src="../assets/js/codemirror/mode/sql/sql.js"></script>
    
    <script src="../assets/js/jquery-1.9.1.min.js"></script>
  
    <script src="../assets/js/bacon.js"></script>
      
</head>

      <body style="overflow:hidden">




<script src="../Infrastructure/NodeFilesAccess.js"></script>        

    <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    
    <script src="../assets/js/bootstrap.min.js"></script>
    <script src="../assets/js/custom.js"></script>

    
    <script src="controllers/Editor.js"></script>
    <script src="controllers/Explorer.js"></script>
    <script src="../assets/js/angular.min.js"></script>
    <script src="../assets/js/amplify.min.js"></script>
    <script>
      var radio = require("radio");
      var modes = {};
      modes.html = "htmlmixed";
      modes.js = "javascript";
      modes.css = "css";
      modes.xml = "xml";
      modes.sql = "sql";
      
      
      
      
        angular.module('editor', [])
               .directive('ngEditor', function () {
                   return function (scope, element, attrs) {
                         var docs = [];
                         var currentDoc;

                         var cm = CodeMirror(element[0], {
                            theme:"ambiance" ,
                            lineNumbers: true, 
                             extraKeys: {
                                "Ctrl-S": function(instance) { 
                                    currentDoc.content = instance.getValue();
                                    radio("SaveCurrentDocument").broadcast(currentDoc);
                                },
                            }
                        });

                        radio("DocumentSelected").subscribe(function(doc){
                          currentDoc = doc;
                          cm.swapDoc(docs[doc.path]);
                          cm.focus();
                        });

                        radio("DocumentLoaded").subscribe(function(doc){
                          var extIdx = doc.path.indexOf(".");
                          var mode;
                          if(extIdx >= 0 )mode = modes[ doc.path.substr( extIdx  + 1 ) ];
                          docs[doc.path] = CodeMirror.Doc(doc.content,mode);
                        });

                     var resize = function(){
                        var $element = $(element);
                        var $parent = $element.closest("#editor");
                        cm.setSize($parent.width(), $parent.height() - $element.position().top );
                    };
                      resize();
                      radio("Reflow").subscribe(resize);

                   };
               });
	
    </script>
        
     <script type="text/ng-template" id="tree_item_renderer.html">
        <a ng-click="onFolderSelected(folder)"><i style="color:white" ng-class="{'icon-folder-open':folder.expanded,'icon-folder-close':!folder.expanded}"></i><span>{{folder.name}}</span></a>
        <div ng-show="folder.expanded">
            <ul>
                <li ng-repeat="folder in folder.folders" ng-include="'tree_item_renderer.html'"></li>
            </ul>
            <ul>
                <li ng-repeat="file in folder.files">
                    <a ng-click="onFileSelected(file.path)"><i class="icon-file" style="color:white"></i><span>{{file.name}}</span></a>
                </li>
            </ul>
        </div>
    </script>
        
        

    <style type="text/css">
      #main
      {
        display:-webkit-flex;
        border-style: solid;
        border-color: white;
        border-width: 2px;
      }

      #browser
      {
        -webkit-flex-basis: 300px;
        
        position: relative;
        overflow:auto;
      }
      
      #handle
      {
        -webkit-flex-basis: 7px;
        background-color:#45484c;
        cursor:w-resize;
      }

      #editor
      {
        -webkit-flex: 5;
        position: relative;
      }
    </style>

      <div id="main">
        <div ng-controller="explorerController" id="browser">
            <ul style="position:absolute;-webkit-user-select:none;">
                <li ng-repeat="folder in folders" ng-include="'tree_item_renderer.html'"></li>
            </ul>
        </div>
        
        <div id="handle"></div>
  
        <div ng-controller="editorController" id="editor">
          <div style="position:absolute">
            <ul class="nav nav-tabs">
                <li ng-class="{active:i.selected}" ng-repeat="i in documents"><a href="#" ng-click="onTabSelected(i.path)">{{i.name}}</a></li>
            </ul>
            <div ng-editor/>
          </div>
        </div>
      </div>

      <script type="text/javascript">
        $(function(){
          $(window).resize(function(){
            var w = $(window);
            var main = $("#main");
            main.width(w.width());
            main.height(w.height());
            radio("Reflow").broadcast();
          });
          
          var mouseDown = $("#handle").asEventStream("mousedown");
          var mouseUp = $("body").asEventStream("mouseup");
          var mouseMove = $("body").asEventStream("mousemove");
          
          mouseDown.onValue(function(e){
            var lastx = e.clientX;
            mouseMove.takeUntil(mouseUp).onValue(function(e){
              var delta = (e.clientX - lastx);
              lastx = e.clientX;
              var browser = $("#browser");
              browser.css("-webkit-flex-basis", (browser.width() + delta)+"px");
              radio("Reflow").broadcast();
            });
          });
          
          radio("DocumentSelected").subscribe(function(d){
            $("title").html(d.path);
          });
          
        });
      </script>

</body>
</html>
